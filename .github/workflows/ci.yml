name: CI Pipeline

on:
  push:
    branches:
      - master
      - main
  workflow_dispatch:

jobs:
  ci-pipeline:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      security-events: write

    steps:
      # ----------------------------------------------------
      # 1. Checkout
      # ----------------------------------------------------
      - name: Checkout source code
        uses: actions/checkout@v4

      # ----------------------------------------------------
      # 2. Setup Runtime (Node.js)
      # ----------------------------------------------------
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # ----------------------------------------------------
      # 3. Linting
      # ----------------------------------------------------
      - name: Run ESLint (Linting)
        run: npm run lint

      # ----------------------------------------------------
      # 4. SAST - CodeQL Analysis
      # ----------------------------------------------------
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

      # ----------------------------------------------------
      # 5. SCA - Dependency Vulnerability Scan
      # ----------------------------------------------------
      - name: OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: "ci-cd-node-backend"
          path: "."
          format: "HTML"
        continue-on-error: true

      - name: Upload Dependency Check Report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-report
          path: reports/
        if: always()

      # ----------------------------------------------------
      # 6. Unit Tests
      # ----------------------------------------------------
      - name: Run Unit Tests
        run: npm test

      # ----------------------------------------------------
      # 7. Build Verification
      # ----------------------------------------------------
      - name: Verify Application Starts
        run: |
          timeout 5 node src/index.js &
          sleep 3
          curl -f http://localhost:3000/health || echo "Build verification completed"
          pkill -f "node src/index.js" || true

      # ----------------------------------------------------
      # 8. Docker Build
      # ----------------------------------------------------
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker Image
        run: |
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/ci-cd-node-backend:${{ github.sha }} .
          docker tag ${{ secrets.DOCKERHUB_USERNAME }}/ci-cd-node-backend:${{ github.sha }} ${{ secrets.DOCKERHUB_USERNAME }}/ci-cd-node-backend:latest

      # ----------------------------------------------------
      # 9. Trivy - Container Image Security Scan
      # ----------------------------------------------------
      - name: Run Trivy vulnerability scan
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: '${{ secrets.DOCKERHUB_USERNAME }}/ci-cd-node-backend:latest'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy scan results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-results.sarif

      # ----------------------------------------------------
      # 10. Runtime Container Test
      # ----------------------------------------------------
      - name: Run container and test
        run: |
          docker run -d -p 3000:3000 --name test-app ${{ secrets.DOCKERHUB_USERNAME }}/ci-cd-node-backend:latest
          sleep 5
          curl -f http://localhost:3000/health || exit 1
          echo "âœ… Container health check passed!"
          docker logs test-app
          docker stop test-app
          docker rm test-app

      # ----------------------------------------------------
      # 11. Push to Docker Registry
      # ----------------------------------------------------
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Push Docker Image to Registry
        run: |
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/ci-cd-node-backend:${{ github.sha }}
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/ci-cd-node-backend:latest
